#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è IPA —Ñ–∞–π–ª–∞ –¥–ª—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./build_ipa.sh [API_BASE_URL]

set -e

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# –ü–æ–ª—É—á–∞–µ–º API URL –∏–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
API_BASE_URL=${1:-"http://192.168.49.65:8000"}

echo -e "${GREEN}üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É IPA —Ñ–∞–π–ª–∞...${NC}"
echo -e "${YELLOW}API Base URL: ${API_BASE_URL}${NC}"
echo ""

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd "$(dirname "$0")"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "pubspec.yaml" ]; then
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞: pubspec.yaml –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ Flutter.${NC}"
    exit 1
fi

# –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–±–æ—Ä–∫–∏
echo -e "${YELLOW}üßπ –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–±–æ—Ä–æ–∫...${NC}"
flutter clean

# –ü–æ–ª—É—á–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo -e "${YELLOW}üì¶ –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...${NC}"
flutter pub get

# –°–æ–±–∏—Ä–∞–µ–º iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ release —Ä–µ–∂–∏–º–µ
echo -e "${YELLOW}üî® –°–±–æ—Ä–∫–∞ iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (Release)...${NC}"
flutter build ipa --release \
    --dart-define=API_BASE_URL="${API_BASE_URL}"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ IPA —Å–æ–∑–¥–∞–Ω
IPA_PATH="build/ios/ipa/tutas_ai_mobile.ipa"

if [ -f "$IPA_PATH" ]; then
    IPA_SIZE=$(du -h "$IPA_PATH" | cut -f1)
    echo ""
    echo -e "${GREEN}‚úÖ IPA —Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!${NC}"
    echo -e "${GREEN}üì¶ –ü—É—Ç—å: ${IPA_PATH}${NC}"
    echo -e "${GREEN}üìä –†–∞–∑–º–µ—Ä: ${IPA_SIZE}${NC}"
    echo ""
    echo -e "${YELLOW}üì§ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:${NC}"
    echo "1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ UDID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –¥–æ–±–∞–≤–ª–µ–Ω –≤ Apple Developer Portal"
    echo "2. –°–æ–∑–¥–∞–π—Ç–µ Ad Hoc Provisioning Profile —Å —ç—Ç–∏–º UDID"
    echo "3. –ü–µ—Ä–µ–ø–æ–¥–ø–∏—à–∏—Ç–µ IPA —Å –Ω–æ–≤—ã–º –ø—Ä–æ—Ñ–∏–ª–µ–º (—á–µ—Ä–µ–∑ Xcode Organizer)"
    echo "4. –û—Ç–ø—Ä–∞–≤—å—Ç–µ IPA —Ñ–∞–π–ª –ø–æ–ª—É—á–∞—Ç–µ–ª—é"
    echo ""
    echo -e "${YELLOW}üí° –î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–µ—Ä–µ–ø–æ–¥–ø–∏—Å–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:${NC}"
    echo "   xcrun altool --sign-app --file ${IPA_PATH} --type ipa"
    echo ""
    
    # –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–ø–∫—É —Å IPA
    open build/ios/ipa/
else
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞: IPA —Ñ–∞–π–ª –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω${NC}"
    exit 1
fi
